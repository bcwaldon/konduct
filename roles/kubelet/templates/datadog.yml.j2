apiVersion: v1
kind: Pod
metadata:
  name: datadog-agent
  namespace: kube-system
spec:
  containers:
  - image: {{ datadog_agent_image }}
    name: datadog-agent
    imagePullPolicy: Always
    ports:
      - containerPort: 8125
        name: dogstatsdport
    env:
      - name: API_KEY
        value: "{{ datadog_api_key }}"
      - name: TAGS
        value: "KubernetesCluster:{{ cluster }},KubernetesClusterRole:{{ cluster_role }}"
{% if datadog_statsd_host is defined and datadog_statsd_port is defined %}
      - name: STATSD_HOST
        value: {{ datadog_statsd_host }}
      - name: STATSD_PORT
        value: {{ datadog_statsd_port }}
{% endif %}
    volumeMounts:
      - name: dockersocket
        mountPath: /var/run/docker.sock
      - name: procdir
        mountPath: /host/proc
        readOnly: true
      - name: cgroups
        mountPath: /host/sys/fs/cgroup
        readOnly: true
  volumes:
    - hostPath:
        path: /var/run/docker.sock
      name: dockersocket
    - hostPath:
        path: /proc
      name: procdir
    - hostPath:
        path: /sys/fs/cgroup
      name: cgroups
